#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var spawn = require('child_process').spawn;

var bindir = path.resolve(__dirname, '..', 'nodewebkit');

function fixperms() {
  Array.prototype.slice.call(arguments).forEach(function(file) {
    if (file.slice(0, 1) !== '/') file = path.resolve(bindir, file);
    fs.chmodSync(file, '755');
  });
}

function run() {
  var bin = bindir;
  if (process.platform === 'darwin') {
    bin = path.join(bin, 'node-webkit.app', 'Contents', 'MacOS', 'node-webkit');
    fixperms(
      'node-webkit.app/Contents/Frameworks/node-webkit Helper.app/Contents/MacOS/node-webkit Helper',
      'node-webkit.app/Contents/Frameworks/node-webkit Helper EH.app/Contents/MacOS/node-webkit Helper EH',
      'node-webkit.app/Contents/Frameworks/node-webkit Helper NP.app/Contents/MacOS/node-webkit Helper NP'
    );
  } else if (process.platform === 'win32') {
    bin = path.join(bin, 'nw.exe');
  } else {
    bin = path.join(bin, 'nw');
    fixperms(bin);
  }
  var args = process.argv.slice(2);
  if (args.length < 1) args = ['.'];
  var nw = spawn(bin, args, { stdio: 'inherit' });
  nw.on('close', function() {
    process.nextTick(function() {
      process.exit(0);
    });
  });
}

if (!fs.existsSync(bindir)) {
  console.log('node-webkit appears to have failed to download and extract. Attempting to download and extract again...');
  var child = spawn(process.argv[0], [path.resolve(__dirname, '..', 'scripts', 'install.js')], { stdio: 'inherit' });
  child.on('close', run);
} else {
  run();
}
